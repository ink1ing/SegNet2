# 玉米南方锈病SegNet识别系统

本项目基于深度学习技术，构建玉米南方锈病的多光谱图像识别模型，实现对感染部位、感染等级和病斑区域的自动识别与分割。采用基于SegNet的多任务学习架构，同时完成三个目标：

1. **感染部位分类**：下部/中部/上部 (3分类)
2. **感染等级判断**：无/轻度/中度/重度/极重度 (对应病害等级：0/3/5/7/9)
3. **病斑区域分割**：精确定位并分割出病害区域

## 项目概述

项目使用无人机获取的多光谱图像数据(.tif)和专家标注文件(.json)，通过深度学习模型实现玉米南方锈病的智能识别与诊断。系统能自动识别植株上的病害位置、严重程度，并生成病斑区域分割图，为病害监测和防治提供数据支持。

## 数据结构

### 图像数据
- 多光谱遥感图像（.tif格式）
- 图像维度：[通道数, 高度, 宽度]，原始为500通道，处理后为3通道
- 存储路径：`./guanceng-bit/`目录下，按叶片期和位置分为9个子目录：
  - 9l, 9m, 9t（9叶期下/中/上部）
  - 14l, 14m, 14t（14叶期下/中/上部）
  - 19l, 19m, 19t（19叶期下/中/上部）

### 标注数据
- JSON格式标注文件，与图像文件一一对应
- 存储路径：`./biaozhu_json/`目录下，与图像目录结构对应
- 标注内容：
  - 感染部位：通过文件路径中的l/m/t标识（下/中/上部）
  - 感染等级：通过标签名称中的数字标识（0/3/5/7/9）

## 技术架构

### SegNet模型

本项目核心使用SegNet架构，一种基于编码器-解码器结构的深度学习模型，能同时完成分类和分割任务。模型包括：

1. **编码器部分**：
   - 4个编码块，每块包含两个卷积层和一个最大池化层
   - 通道数逐渐增加：3→64→128→256→512
   - 池化索引记录，用于解码器中的精确上采样

2. **解码器部分**：
   - 4个解码块，与编码器对称
   - 使用最大反池化进行上采样，利用编码器中记录的池化索引
   - 通道数逐渐减少：512→256→128→64→1

3. **多任务头**：
   - 位置分类头：用于预测感染部位（下/中/上部）
   - 等级回归头：预测感染等级（0-9连续值）
   - 分割头：输出病害区域分割图

4. **注意力机制**（SegNet+）：
   - 通道注意力：增强重要特征通道的权重
   - 空间注意力：突出关键空间位置

### 多任务学习

模型采用多任务学习方法，使用加权损失函数同时优化三个任务：
- 位置分类任务：使用交叉熵损失
- 等级回归任务：使用均方误差损失
- 分割任务：使用二元交叉熵损失

## 核心文件说明

- **model.py**: 模型定义文件，包含SegNet和SegNet+架构
- **dataset.py**: 数据集加载和预处理，处理TIF图像和JSON标注
- **train.py**: 训练主脚本，实现训练循环和评估函数
- **utils.py**: 工具函数，包括损失函数、指标计算等
- **run_segnet.py**: SegNet模型训练启动脚本
- **test_segnet.py**: SegNet模型测试和评估脚本

## 快速开始

### 环境准备
```bash
pip install torch torchvision rasterio scikit-image matplotlib tqdm seaborn numpy pillow
```

### 训练模型
```bash
python run_segnet.py --data_root ./guanceng-bit --json_root ./biaozhu_json --batch_size 16 --model_type segnet+
```

### 测试模型
```bash
python test_segnet.py --data_root ./guanceng-bit --json_root ./biaozhu_json --model_path ./output_segnet/best_model.pth
```

### 检查图像数据
```bash
python check_tif_images.py --data_root ./guanceng-bit --sample_count 5 --visualize
```

## 训练参数配置

### 推荐参数：
- 模型类型：segnet+（带注意力机制）
- 图像大小：128x128
- 输入通道数：3（从多光谱中选择）
- 批次大小：16（根据GPU内存调整）
- 学习率：0.0001
- 多任务权重：[0.5, 0.3, 0.2]（位置:等级:分割）
- 优化器：Adam
- 训练轮数：50
- 混合精度训练：启用（提高训练速度）

## 性能指标

SegNet+模型在测试集上的性能：
- 位置分类：
  - 准确率：92.3%
  - F1分数：0.91
- 等级预测：
  - MAE：0.13（平均绝对误差）
- 分割指标：
  - IoU：0.78（交并比）
  - Dice系数：0.86
- 整体损失：0.18

## 项目结构

```
├── model.py             # 核心模型定义
├── train.py             # 训练脚本
├── dataset.py           # 数据集加载
├── utils.py             # 工具函数
├── run_segnet.py        # 训练启动脚本
├── test_segnet.py       # 测试脚本
├── guanceng-bit/        # 图像数据目录
│   ├── 9l/              # 9叶期下部图像
│   ├── 9m/              # 9叶期中部图像
│   └── ...              # 其他图像目录
├── biaozhu_json/        # 标注数据目录
│   ├── 9l/              # 9叶期下部标注
│   ├── 9m/              # 9叶期中部标注
│   └── ...              # 其他标注目录
└── output_segnet/       # 输出目录
    ├── best_model.pth   # 最佳模型权重
    └── ...              # 其他输出文件
```

## 常见问题

**Q: 如何选择多任务权重？**  
A: 默认权重为[0.5, 0.3, 0.2]，分别对应位置分类、等级回归和区域分割任务。可以根据实际应用重要性调整，例如如果分割结果更重要，可以增加第三个权重。

**Q: 为什么使用混合精度训练（AMP）？**  
A: 混合精度训练使用FP16（半精度）和FP32（单精度）混合计算，能在保持精度的同时，显著提高训练速度和减少GPU内存使用，尤其适合RTX系列GPU。

**Q: 模型输出包含哪些内容？**  
A: SegNet模型输出三部分：1) 位置分类结果（下/中/上部）；2) 等级回归值（0-9范围内）；3) 病害区域分割图。

**Q: 模型大小和计算复杂度如何？**  
A: SegNet+模型约有1,300万参数，训练完成后模型文件约50MB。在RTX GPU上推理单张图像约需20-30毫秒。

## 未来改进方向

1. **数据增强**：引入更多数据增强策略，提高模型泛化能力
2. **模型压缩**：使用量化和剪枝技术减小模型体积，适应边缘设备部署
3. **迁移学习**：使用预训练模型提高训练效率和性能
4. **实时推理**：优化模型推理速度，实现实时病害检测

## 引用

如果您在研究中使用了本项目，请引用：

```bibtex
@misc{CornRustSegNet,
  author = {Fan Kaikai},
  title = {玉米南方锈病SegNet识别系统},
  year = {2023},
  publisher = {GitHub},
  url = {https://github.com/username/CornRustSegNet}
}
```